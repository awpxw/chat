# .github/workflows/ci-cd.yml   （建议改个名字，一目了然）
name: CI/CD + SonarCloud

on:
  push:
    branches: [ main, dev, release/* ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  # 第一步：检测哪些模块改动了（你原来的逻辑完全保留）
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      matrix: ${{ steps.detect.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 检测改动模块
        id: detect
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | cut -d/ -f1 | sort -u | grep -vE '^\.github$|^common$|^$' | paste -sd, -)
          if [ -z "$CHANGED" ]; then
            echo "无服务模块改动，跳过构建"
            echo "changed=none" >> $GITHUB_OUTPUT
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            echo "检测到改动模块: $CHANGED"
            echo "changed=$CHANGED" >> $GITHUB_OUTPUT
            MATRIX=$(echo "$CHANGED" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
            echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          fi

  # 第二步：真正干活（编译 + SonarCloud 分析 + Jib 推送）
  build-analyze-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed != 'none' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # PR 时强制扫描全量，push 时只扫改动的模块
        module: ${{ fromJson(needs.detect-changes.outputs.matrix || '[]') }}
        include:
          # 如果是 PR 或者 matrix 为空（比如只改了 pom.xml），就加一个全量扫描任务
          - module: ''
            full-scan: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # SonarCloud 必须完整历史

      - name: 设置 JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: temurin

      - name: Maven 缓存
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-

      # ======== 登录 Docker Hub（只在 push 时需要）========
      - name: 登录 Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}   # 必须是带 Write 权限的 Access Token

      # ======== 编译 + Jib 推送（只在 push 且有具体模块时执行）========
      - name: Jib 构建并推镜像
        if: github.event_name == 'push' && matrix.module != ''
        run: |
          echo "正在发布服务: ${{ matrix.module }}"
          mvn -B compile jib:build -pl ${{ matrix.module }} -am -DskipTests \
            -Djib.to.image=${{ secrets.DOCKER_USERNAME }}/chat-${{ matrix.module }} \
            -Djib.to.tags=latest,${{ github.sha }},${{ github.ref_name }}

      # ======== SonarCloud 分析（核心）========
      - name: SonarCloud 分析
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          if [ "${{ matrix.module }}" != "" ]; then
            # 改动模块：只扫这个模块
            mvn -B verify -DskipTests \
              org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
              -pl ${{ matrix.module }} -am \
              -Dsonar.projectKey=jacky-org_chat \
              -Dsonar.organization=jacky-org
          else
            # PR 或全量情况：扫整个项目
            mvn -B verify -DskipTests \
              org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
              -Dsonar.projectKey=jacky-org_chat \
              -Dsonar.organization=jacky-org
          fi

      - name: 发布成功提示
        if: github.event_name == 'push' && matrix.module != ''
        run: echo "镜像已推送到 https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/chat-${{ matrix.module }}"