# Git Flow 发版流程

## 一、分支角色与职责

| 分支类型          | 用途与定位                                   | 保护级别 | 允许直接 Push | 合并权限       | 生命周期       |
|-------------------|----------------------------------------------|----------|---------------|----------------|----------------|
| `main`            | 生产环境现网代码，随时可发版                 | 最高     | 禁止          | 仅管理员       | 永久           |
| `release/x.y.z`   | 即将上线版本（预发、灰度、正式发布）         | 高       | 禁止          | 仅发版负责人   | 发布后归档     |
| `hotfix/*`        | 线上紧急修复                                 | 中       | 仅 Hotfix Leader | 仅管理员     | 发布后删除     |
| `dev`             | 日常集成 + 测试环境代码                     | 中       | 允许          | 仅管理员       | 永久           |
| `feature/*`       | 新功能开发（单功能原则，周期 ≤ 10 天）       | 无       | 允许          | 开发者本人     | 完成后删除     |
| `bugfix/*`        | 非紧急缺陷修复                               | 无       | 允许          | 开发者本人     | 完成后删除     |

## 二、标准发版流程（功能类）

1. **开发阶段**  
   从 `dev` 拉取新分支 `feature/功能简述`（或 `bugfix/缺陷简述`）进行开发

2. **代码提交与审查**  
   开发完成后提交 PR 至 `dev`，必须满足：
    - 标题符合 Conventional Commits 规范
    - 关联任务管理系统编号（如 Jira）
    - 通过自动化单元测试、代码风格检查、Sonar 质量门禁
    - 至少 1 名同事完成 Code Review

3. **集成测试**  
   合并至 `dev` 后在测试环境完成全链路验证

4. **创建发版分支**  
   每周固定发版日（建议周二/周四）由发版负责人执行：
   ```bash
   git checkout main && git pull
   git checkout -b release/x.y.z
   ```

5. **预发与灰度**  
   将 `release/x.y.z` 部署至预发 → 灰度环境 → 验证通过

6. **正式发布**  
   发版负责人执行：
   ```bash
   git checkout main
   git merge --no-ff release/x.y.z
   git tag -a vX.Y.Z -m "发版说明"
   git push origin main --tags
   git checkout dev && git merge main
   ```

7. **自动化部署**  
   GitHub Actions 检测到 `main` 分支更新或 Tag 后自动构建镜像并推送，服务器端 Watchtower 自动拉取并重启

## 三、紧急热修复流程（Hotfix）

1. 从 `main` 直接拉取 `hotfix/简要描述` 分支
2. 修复后同时提交 PR 至 `main` 与 `dev`
3. 合并后打热修复 Tag：`vX.Y.Z-hotfix.N`
4. 镜像自动构建并推送，10 分钟内全量生效

## 四、强制性技术规范（红线）

| 类别               | 具体要求                                                                 | 违规后果               |
|--------------------|--------------------------------------------------------------------------|------------------------|
| 分支保护           | `main`、`dev`、`release/*` 禁止强制推送，必须走 PR，至少 1 人 Review     | 直接打回 + 记录         |
| CI 检查门禁        | - 单元测试覆盖率 ≥ 70%<br>- Sonar 质量门禁（Bug=0，安全漏洞 ≤ A）<br>- Spotless 格式检查 | PR 无法合并            |
| 发版限制           | - 禁止周五 15:00 后非紧急发版<br>- 禁止 Cherry-pick 到 main/release<br>- 禁止跨 2 个大版本直接合并 | 发版驳回 + 当月考核扣分 |

## 五、总结一句话

> **所有日常开发必须基于 `dev` → `feature/*` → PR 合并 → 集成测试 → 统一进入 `release` 分支 → 预发验证 → 合并 `main` 并打 Tag → 自动化部署。**  
> **任何绕过此流程的提交均视为严重违规。**

遵循以上规范，团队即可实现：
- 开发者只负责写代码和提 PR
- 发版、构建、部署、回滚全部自动化
- 达到行业顶级成熟度（Level 4+）.

**从今天起，发版不再心惊胆战，只剩优雅与从容！**